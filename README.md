# Codon Usage Bias Analysis in R

A comprehensive bioinformatics pipeline for analyzing **Codon Usage Bias (CUB)** in bacterial genomes using R. This project demonstrates RSCU, GC3s, ENC, CAI, MILC, MELP analyses, and KEGG pathway enrichment — applied to *Enterococcus faecalis* as a case study.

## Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Required External Files](#required-external-files)
- [Installation](#installation)
- [Pipeline Summary](#pipeline-summary)
  - [1. Data Loading & Cleaning](#1-data-loading--cleaning)
  - [2. RSCU Analysis](#2-rscu-analysis)
  - [3. GC3s Analysis](#3-gc3s-analysis)
  - [4. ENC – Effective Number of Codons](#4-enc--effective-number-of-codons)
  - [5. Translational Efficiency (MILC)](#5-translational-efficiency-milc)
  - [6. CAI – Codon Adaptation Index](#6-cai--codon-adaptation-index)
  - [7. Visualization](#7-visualization)
  - [8. KEGG Pathway Enrichment](#8-kegg-pathway-enrichment)
- [Required External Files & How to Obtain Them](#required-external-files--how-to-obtain-them)
- [References](#references)
- [License](#license)

## Overview

Codon Usage Bias refers to the phenomenon where synonymous codons (codons encoding the same amino acid) are not used equally across genes or genomes. This bias is shaped by **mutational pressure** and **translational selection**, and studying it reveals how organisms optimize gene expression and adapt to their environments.

This pipeline analyzes:

| Metric | Description |
|--------|-------------|
| **RSCU** | Relative Synonymous Codon Usage — identifies preferred vs. avoided codons |
| **GC3s** | GC content at the third codon position — reflects mutational and selective pressure |
| **ENC** | Effective Number of Codons (20–61) — measures the degree of codon bias |
| **CAI** | Codon Adaptation Index — measures gene adaptation relative to the RSCU reference |
| **MILC** | Measure Independent of Length and Composition — evaluates translational efficiency |
| **MELP** | MILC-based Expression Level Predictor — predicts gene expression levels |

## Prerequisites

- **R** (≥ 4.0)
- **RStudio** (recommended)
- The following R packages:

| Package | Source | Purpose |
|---------|--------|---------|
| `BiocManager` | CRAN | Bioconductor package manager |
| `Biostrings` | Bioconductor | DNA/RNA/AA string manipulation |
| `BiocGenerics` | Bioconductor | Bioconductor core infrastructure |
| `cubar` | CRAN / Bioconductor | RSCU, GC3s, ENC, CAI computation |
| `coRdon` | Bioconductor | MILC, MELP, B-plot, enrichment analysis |
| `ggplot2` | CRAN | Data visualization |

## Required External Files

> **⚠️ Important:** This analysis requires files that are **not included** in this repository. You must obtain them separately as described below.

### 1. CDS FASTA File (`.cds.all.fa.gz`)

Your bacterial coding sequence (CDS) file from Ensembl Bacteria.

**How to obtain:**
1. Navigate to [Ensembl Bacteria FTP](https://ftp.ensemblgenomes.ebi.ac.uk/)
2. Follow the path: `/pub/bacteria/release-62/fasta/{your_selected_collection}/{your_bacteria}/cds/`
3. Download the `*.cds.all.fa.gz` file
4. Place it in the `data/` directory of this project

### 2. KO Annotation File (`user_ko.txt`)

KEGG Orthology annotations generated by GhostKOALA.

**How to obtain:**
1. Run the pipeline up to the protein translation step (the script will generate `entereco_proteins.fasta`)
2. Go to [GhostKOALA](https://www.kegg.jp/ghostkoala/)
3. Upload `entereco_proteins.fasta`
4. Select **"Prokaryotes + Viruses"** as the reference gene dataset
5. Submit with an **institutional email address**
6. Check your email and download `user_ko.txt`
7. Place it in the project root directory

## Installation

```r
# Install BiocManager (if not already installed)
install.packages("BiocManager")

# Install Bioconductor packages
BiocManager::install(c("BiocGenerics", "Biostrings", "coRdon"))

# Install CRAN packages
install.packages(c("cubar", "ggplot2"))
```

## Pipeline Summary

### 1. Data Loading & Cleaning

Load CDS sequences and clean non-standard characters from DNA strings:

```r
my_path <- file.choose()
entereco_fea <- readSet(file = my_path)

# Clean sequences — remove non-ACGTN characters
raw_seq <- as.character(entereco_fea)
clean_seq <- gsub("[^ACGTNacgtn]", "", raw_seq)
clean_cds <- DNAStringSet(clean_seq)
clean_set <- check_cds(clean_cds)
```

### 2. RSCU Analysis

**Relative Synonymous Codon Usage** identifies which codons are preferred by the organism.

- **RSCU > 1.0** → Preferred codon
- **RSCU < 1.0** → Under-represented / avoided codon

```
RSCU = Observed count / (Total amino acid count / Number of synonymous codons)
```

```r
codon_frequence <- count_codons(clean_set)
rscu_values <- est_rscu(codon_frequence)
```

### 3. GC3s Analysis

GC content at the 3rd codon position. G-C pairs form three hydrogen bonds (vs. two for A-T), making them thermally more stable. GC3s values reveal mutational and selective pressures on the genome.

```r
gc3s_value <- get_gc3s(codon_frequence)
mean_gc3s <- mean(gc3s_value)  # Multiply by 100 for percentage
```

### 4. ENC – Effective Number of Codons

Measures the degree of codon bias per gene (range: 20–61).

- **ENC = 61** → No bias (random codon usage)
- **ENC = 20** → Maximum bias (strong preference)

```r
enc_values <- get_enc(codon_frequence)
```

### 5. Translational Efficiency (MILC)

Uses ribosomal protein genes as a reference. Genes with codon usage similar to ribosomal genes are predicted to be highly expressed.

```r
entr_table <- codonTable(entereco_fea)
milc_values <- MILC(entr_table, self = TRUE, ribosomal = TRUE, filtering = "hard")
```

### 6. CAI – Codon Adaptation Index

Measures how well each gene's codon usage matches the optimal (RSCU-derived) codon usage pattern. Values range from 0 to 1 (1 = perfectly adapted).

```r
cai_values <- get_cai(codon_frequence, rscu_values, "subfam")
```

### 7. Visualization

#### ENC vs CAI Scatter Plot (with GC3s heatmap)

```r
df <- data.frame(ENC = enc_values, CAI = cai_values, GC3s = gc3s_value)

ggplot(data = df, aes(x = ENC, y = CAI, color = GC3s)) +
  geom_point(position = "jitter") +
  scale_colour_gradient(low = "blue", high = "yellow") +
  labs(title = "Codon Usage Relationship", x = "ENC", y = "CAI")
```

#### B-Plot (Translational Selection)

> Requires `user_ko.txt` from GhostKOALA (see [Required External Files](#required-external-files--how-to-obtain-them))

```r
Bplot(x = "ribosomal", y = "self",
      data = as.matrix(new_milc_values),
      ribosomal = TRUE,
      annotations = getKO(new_entr_table),
      size = 2) +
  labs(title = "B-Plot: Translational Selection",
       x = "MILC Distance from Average (Self)",
       y = "MILC Distance from Ribosomal Reference")
```

**Interpreting the B-plot:**
- **Y-axis** (Distance to Ribosomal Reference): Lower values → gene is optimized for fast protein production
- **X-axis** (Distance to Genome Average): Measures how much a gene deviates from the genome-wide average

### 8. KEGG Pathway Enrichment

Predicts expression levels using MELP and identifies enriched biological pathways.

```r
melp_vals <- MELP(new_entr_table, ribosomal = TRUE, filtering = "hard")
get_annots <- getKO(new_entr_table)
ct <- crossTab(get_annots, as.numeric(melp_vals), threshold = 1L)
ct_path <- reduceCrossTab(ct, target = "pathway")
enr_results <- enrichment(ct_path)

enrichBarplot(enr_results, variable = "enrich", pvalue = "pvals") +
  theme_bw() +
  labs(title = "Pathway Enrichment Analysis",
       subtitle = "Based on MELP expression prediction")
```

## References

- [Ensembl Bacteria FTP](https://ftp.ensemblgenomes.ebi.ac.uk/)
- [GhostKOALA – KEGG](https://www.kegg.jp/ghostkoala/)
- [cubar R package](https://cran.r-project.org/package=cubar)
- [coRdon Bioconductor package](https://bioconductor.org/packages/coRdon/)
- [ggplot2 Cheatsheet](https://github.com/rstudio/cheatsheets/blob/main/data-visualization.pdf)
- Sharp, P.M. & Li, W.H. (1987). The codon adaptation index — a measure of directional synonymous codon usage bias. *Nucleic Acids Research*, 15(3), 1281–1295.

## License

This project is licensed under the MIT License. See [LICENSE](LICENSE) for details.
